---
title: ã€Swiftã€‘iOSã§StableDiffusionã‚’ä½¿ã£ã¦ã¿ãŸ
tags:
  - iOS
  - Swift
  - SwiftUI
  - StableDiffusion
private: false
updated_at: '2022-12-08T22:23:32+09:00'
id: 2d33dc535cf106189f75
organization_url_name: null
slide: false
ignorePublish: false
---
# ã¯ã˜ã‚ã«
Appleã‹ã‚‰StableDiffusionã®CoreMLå¤‰æ›ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚
StableDiffusionã«èˆˆå‘³ãŒã‚ã£ãŸã®ã§ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚

https://github.com/apple/ml-stable-diffusion

ã—ã‹ã—ã€READMEã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ã ã¨è²§å¼±ãƒ¡ãƒ¢ãƒªã®MacBookã§ã¯ã§ããªã‹ã£ãŸã®ã§ã€è²§å¼±MacBookã§ã‚‚ã§ãã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒª
ä»Šå›žã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã¯ã“ã¡ã‚‰ã§ã™ã€‚

ä»¥ä¸‹ã®è¨­å®šãŒã§ãã¾ã™ã€‚
- Prompt
- Image Count
- Step Count
- Seed
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-08 22.03.05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/6c20fa77-c559-9656-03ba-3b46c631723a.png)

ã¡ãªã¿ã«ã€ŒStepCountã€ã‚’50ã«ã™ã‚‹ã¨ç”Ÿæˆã¾ã§ã«1æ™‚é–“ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ç¬‘

ã“ã®ä¾‹ã§ã¯ã€ŒStepCountã€ã¯5ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
å®Œæˆã¾ã§10åˆ†ã‹ã‹ã‚Šã¾ã—ãŸã€‚

|0|1|2|3|4|5|
|-|-|-|-|-|-|
|![simulator_screenshot_2E0395A8-23DA-437E-9539-7A98A83F372F.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/bf559f9f-0f90-a33e-209a-22946ecdeb1b.png)|![simulator_screenshot_4FE43A8A-8B2F-43DC-B9DE-6F3B7FEBF611.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/ac103caf-e0d2-f230-b441-ca838d82fda9.png)|![simulator_screenshot_78CF14C5-7A9B-4E50-8140-ECE54F21107C.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/99ad1bbb-e481-d0e2-bf39-fa03b8feabb4.png)|![simulator_screenshot_E8D74D40-3147-4580-A586-FCD09CA6B287.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/9bdb4e50-3d03-ca22-ac2f-6be5c5590f5f.png)|![simulator_screenshot_7277CE6C-3091-42FB-812C-F73126A148CA.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/caadb4b1-f475-f254-fbe1-8835ac384505.png)|![simulator_screenshot_BCE30048-FFDC-43AE-BFD6-E1CB7B80354D.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/d17ffa14-0474-af4c-50d2-670a62632dde.png)|

å®Œæˆã—ãŸç”»åƒï¼ï¼
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-08 21.56.48.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/0d4544be-caca-8cf2-c9fc-9b72c84ed414.png)

# æº–å‚™
### ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
Hugging Faceã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-06 18.37.10.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/296f8849-247c-1f42-8e6e-3db537080b4e.png)
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-06 18.39.43.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/eb11c5b4-a6f9-84cd-2bc6-084870a1637d.png)

[ã“ã¡ã‚‰](https://huggingface.co/settings/tokens)ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-06 18.41.31.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/f4120495-36e1-b3e0-cd50-b96221e862d3.png)

ã€ŒNameã€ã¨ã€ŒRoleã€ã‚’æŒ‡å®šã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-06 18.46.23.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/d0fa6a99-08cf-154b-ae0b-e42a5f73675b.png)

### Hugging Face APIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
å…ˆã»ã©ã®ä»®æƒ³ç’°å¢ƒå†…ã‹ã¤ã€ml-stable-diffusionã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
huggingface-cli login
```
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-06 18.49.19.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/bfdf161a-8b05-bcbc-942e-488603af73bd.png)
ä¸Šè¨˜ã®ç”»åƒã®ã‚ˆã†ã«ãƒˆãƒ¼ã‚¯ãƒ³ã®å…¥åŠ›ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§å…ˆã»ã©ç”Ÿæˆã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-06 18.50.33.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/d16f53a0-dca5-53ab-b3ed-9b1eb9c7f8de.png)

### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚
```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
cd ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ãƒ‘ã‚¹
git clone https://github.com/apple/ml-stable-diffusion.git
cd ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ãƒ‘ã‚¹/ml-stable-diffusion
```
è‡ªåˆ†ã®MacBookã§ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ããªã„ãŸã‚ã€appleã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
ä»Šã®æ‰€ã€ã“ã®3ã¤ãŒã‚ã‚Šã¾ã™ã€‚
- `apple/coreml-stable-diffusion-v1-4`
- `apple/coreml-stable-diffusion-v1-5`
- `apple/coreml-stable-diffusion-2-base`
```python
from huggingface_hub import snapshot_download
from huggingface_hub.file_download import repo_folder_name
from pathlib import Path
import shutil

# ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ãƒ¢ãƒ‡ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
repo_id = "apple/coreml-stable-diffusion-v1-4"
#repo_id = "apple/coreml-stable-diffusion-v1-5"
#repo_id = "apple/coreml-stable-diffusion-2-base"
variant = "original/compiled"

def download_model(repo_id, variant, output_dir):
    destination = Path(output_dir) / (repo_id.split("/")[-1] + "_" + variant.replace("/", "_"))
    if destination.exists():
        raise Exception(f"Model already exists at {destination}")

    downloaded = snapshot_download(repo_id, allow_patterns=f"{variant}/*", cache_dir=output_dir)
    downloaded_bundle = Path(downloaded) / variant
    shutil.copytree(downloaded_bundle, destination)

    cache_folder = Path(output_dir) / repo_folder_name(repo_id=repo_id, repo_type="model")
    shutil.rmtree(cache_folder)
    return destination

model_path = download_model(repo_id, variant, output_dir="./models")
print(f"Model downloaded at {model_path}")
```

å…ˆã»ã©ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
python3 ä½œæˆã—ãŸPythonãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
```

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ãŸã‚‰`coreml-stable-diffusion-v1-4_original_compiled`ã¨ã„ã†åå‰ã®ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-08 12.34.51.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/d1bd5b48-7fe8-9f66-63fc-63636ac48de3.png)

# å®Ÿè£…
### ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
SPMã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
Branchã®mainã‚’è¨­å®šã—ã¦ã€ŒAdd Packageã€ã‚’é¸æŠžã—ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-08 12.42.19.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/0875ccf4-1eaa-7c7d-77d8-187d748c7455.png)

`StableDiffusion`ã‚’é¸æŠžã—ã¦ã€ŒAdd Packageã€ã‚’é¸æŠžã—ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-08 12.43.18.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/5c436dc1-cba4-2464-3af8-2af937abe234.png)

https://github.com/apple/ml-stable-diffusion

### ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’`coreml-stable-diffusion-v1-4_original_compiled`ã”ã¨ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®è¨­å®šã§ã€ŒFinishã€ã‚’é¸æŠžã—ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-08 12.38.47.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/3adcfe84-e595-df53-e156-6adb4250b24e.png)
ã“ã®ã‚ˆã†ãªå½¢ã«ãªã‚Šã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-08 12.40.05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1745371/efc5db48-9e74-9b8a-dedb-ecd25c0ced27.png)

### ã‚³ãƒ¼ãƒ‰
#### View
```swift:ContentView
import SwiftUI

struct ContentView: View {
    @StateObject private var viewModel = ViewModel()
    var body: some View {
        ScrollView(.vertical, showsIndicators: false) {
            Text(viewModel.status.message)
                .foregroundColor(.primary)
                .font(.system(size: 25, weight: .bold))
            if viewModel.status == .generateStart {
                ProgressView(value: .init(Double(viewModel.step)), total: .init(Double(viewModel.stepCount))) {
                    Text("ç”Ÿæˆä¸­")
                } currentValueLabel: {
                    Text("(\(viewModel.step)/\(Int(viewModel.stepCount)))")
                }
                .progressViewStyle(CircularProgressViewStyle())
            }
            if let image = viewModel.image {
                slideImageView(image: image)
            } else {
                Text("ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„")
                    .frame(maxWidth: .infinity, minHeight: 300)
                    .background(Color.gray.opacity(0.3))
                    .cornerRadius(10)
            }
            GroupBox("Prompt") {
                TextField("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", text: $viewModel.prompt, axis: .vertical)
                    .textFieldStyle(.roundedBorder)
                    .disabled(viewModel.status == .generateStart)
            }
            GroupBox("Image Count") {
                Stepper(value: $viewModel.imageCount, in: 1...4) {
                    Text("\(viewModel.imageCount)")
                }
                .disabled(viewModel.status == .generateStart)
            }
            GroupBox("Step Count") {
                Text(Int(viewModel.stepCount).description)
                    .frame(maxWidth: .infinity, alignment: .leading)
                Slider(value: $viewModel.stepCount, in: 1...50, step: 1)
                    .disabled(viewModel.status == .generateStart)
            }
            GroupBox("Seed") {
                Text(Int(viewModel.seed).description)
                    .frame(maxWidth: .infinity, alignment: .leading)
                Slider(value: $viewModel.seed, in: 0...1000, step: 1)
                    .disabled(viewModel.status == .generateStart)
            }
            Button {
                Task.init {
                    await viewModel.generateImage()
                }
            } label: {
                Text("ç”Ÿæˆ")
                    .foregroundColor(.white)
                    .font(.system(size: 25, weight: .bold))
                    .frame(maxWidth: .infinity, minHeight: 70)
            }
            .frame(maxWidth: .infinity, minHeight: 70)
            .background(viewModel.status != .loadFinish || viewModel.status == .generateStart || viewModel.prompt == "" ? Color.secondary : Color.blue)
            .cornerRadius(10)
            .disabled(viewModel.status != .loadFinish || viewModel.status == .generateStart || viewModel.prompt == "")
        }
        .padding(.all)
        .task {
            Task.init {
                await viewModel.loadModels()
            }
        }
    }

    private func slideImageView(image: [CGImage]) -> some View {
        TabView {
            ForEach(0..<image.count, id: \.self) { index in
                Image(image[index], scale: 1.0, label: Text("ç”Ÿæˆç”»åƒ"))
                    .resizable()
                    .scaledToFit()
            }
        }
        .tabViewStyle(.page)
        .indexViewStyle(PageIndexViewStyle(backgroundDisplayMode: .interactive))
        .frame(maxWidth: .infinity, minHeight: 400)
        .background(Color(uiColor: .secondarySystemFill))
        .cornerRadius(10)
    }
}
```

#### ViewModel
```swift:ViewModel
import Foundation
import StableDiffusion
import CoreGraphics

final class ViewModel: ObservableObject {
    @Published var pipeline: StableDiffusionPipeline?
    @Published var image: [CGImage]?
    @Published var prompt: String = "cat"
    @Published var imageCount: Int = 1
    @Published var stepCount: Double = 30
    @Published var seed: Double = 500
    @Published var step: Int = 0
    @Published var status: StableDiffusionStatus = .ready

    func loadModels() async {
        guard let resourceURL = Bundle.main.resourceURL else { return }
        do {
            Task.detached { @MainActor in
                self.status = .loadStart
            }
            let pipeline = try StableDiffusionPipeline(resourcesAt: resourceURL)
            Task.detached { @MainActor in
                self.pipeline = pipeline
                self.status = .loadFinish
            }
        } catch {
            Task.detached { @MainActor in
                self.status = .error
            }
        }
    }

    func generateImage() async {
        do {
            Task.detached { @MainActor in
                self.image = nil
                self.status = .generateStart
            }
            let image = try self.pipeline?.generateImages(
                prompt: self.prompt,
                imageCount: self.imageCount,
                stepCount: Int(self.stepCount),
                seed: Int(self.seed),
                disableSafety: true
            ) { data in
                Task.detached { @MainActor in
                    self.image = data.currentImages.map({ cgImage in
                        guard let cgImage else { fatalError() }
                        return cgImage
                    })
                    self.step = data.step
                }
                return true
            }.map({ cgImage in
                guard let cgImage else { fatalError() }
                return cgImage
            })
            Task.detached { @MainActor in
                self.image = image
                self.status = .generateFinish
            }
        } catch {
            Task.detached { @MainActor in
                self.status = .error
            }
        }
    }
}
```
#### Model
```swift:StableDiffusionStatus
import Foundation

enum StableDiffusionStatus {
    case ready
    case loadStart
    case loadFinish
    case generateStart
    case generateFinish
    case error

    var message: String {
        switch self {
        case .ready:
            return "æº–å‚™ä¸­"
        case .loadStart:
            return "ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ"
        case .loadFinish:
            return "ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ãŒçµ‚äº†ã—ã¾ã—ãŸ"
        case .generateStart:
            return "ç”»åƒç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã—ãŸ"
        case .generateFinish:
            return "ç”»åƒç”ŸæˆãŒçµ‚äº†ã—ã¾ã—ãŸ"
        case .error:
            return "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        }
    }
}
```

# ãŠã‚ã‚Š
ä¸€å¿œã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã¾ã™ãŒã€éžåŒæœŸå‡¦ç†ã®ã¨ã“ã‚ãŒãŠã‹ã—ã„ã®ã§ã€èª°ã‹æ•™ãˆã¦ãã ã•ã„ç¬‘

ã‚‚ã—ç›´ã—ã¦ã„ãŸã ã‘ã‚‹å„ªã—ã„æ–¹ãŒã„ã¾ã—ãŸã‚‰PRãã ã•ã„ðŸ™

https://github.com/SNQ-2001/ml-stable-diffusion-ios-demo
